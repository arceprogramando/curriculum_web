---
import {
  getCV,
  getLocaleConfig,
  getAllLocaleUrls,
  getOtherLocales,
  LOCALES,
  DEFAULT_LOCALE,
  type Locale
} from '@/lib/i18n';
import '@/styles/theme.css';

interface Props {
  title?: string;
  locale?: Locale;
}

const { locale = DEFAULT_LOCALE } = Astro.props;
const config = getLocaleConfig(locale);
const cv = getCV(locale);
const { image } = cv.basics;

const currentPath = Astro.url.pathname;
const canonicalUrl = `https://arceprog.dev${currentPath}`;
const localeUrls = getAllLocaleUrls();
const otherLocales = getOtherLocales(locale);

// Fecha de última actualización (se actualiza en cada build)
const buildDate = new Date().toISOString();

// Breadcrumb para SEO
const breadcrumbName = locale === 'es' ? 'Inicio' : 'Home';

// Skills expandidos para knowsAbout
const allSkills = [
  "JavaScript", "TypeScript", "React", "React Native", "Next.js",
  "Node.js", "Express.js", "NestJS", "MongoDB", "PostgreSQL", "SQL",
  "HTML", "CSS", "Tailwind CSS", "Material UI", "Git", "GitHub",
  "Figma", "Jira", "Scrum", "REST API", "Linux", "Fedora"
];
---

<!doctype html>
<html lang={config.htmlLang}>
  <head>
    <meta charset="UTF-8" />
    <title>{config.pageTitle}</title>
    <meta name="description" content={config.metaDescription} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- SEO: Canonical y hreflang (generado dinámicamente para todos los idiomas) -->
    <link rel="canonical" href={canonicalUrl} />
    {LOCALES.map(loc => (
      <link rel="alternate" hreflang={loc} href={localeUrls[loc]} />
    ))}
    <link rel="alternate" hreflang="x-default" href={localeUrls[DEFAULT_LOCALE]} />

    <!-- Preload critical resources -->
    <link rel="preload" as="image" href={image} />
    <link rel="preload" as="image" href="/portada-og.png" />
    <link rel="preconnect" href="https://res.cloudinary.com" />
    <link rel="preconnect" href="https://avatars.githubusercontent.com" />
    <link rel="dns-prefetch" href="https://res.cloudinary.com" />
    <link rel="dns-prefetch" href="https://avatars.githubusercontent.com" />

    <meta name="google-site-verification" content="jfdI3O_sVUKVWOWPcViT3dZF-JayDl6N87uwcqGkXXU" />

    <!-- Facebook Meta Tags / Open Graph (usado por WhatsApp, LinkedIn, etc) -->
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={config.ogTitle} />
    <meta property="og:description" content={config.ogDescription} />
    <meta property="og:site_name" content="Felipe Arce Portfolio" />
    <meta property="og:image" content="https://arceprog.dev/portada-og.png" />
    <meta property="og:image:secure_url" content="https://arceprog.dev/portada-og.png" />
    <meta property="og:image:alt" content={`${config.ogTitle} | Portfolio`} />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content={config.ogLocale} />
    {otherLocales.map(loc => (
      <meta property="og:locale:alternate" content={getLocaleConfig(loc).ogLocale} />
    ))}

    <!-- Meta tags adicionales -->
    <meta property="og:updated_time" content={buildDate} />
    <meta name="robots" content="index, follow" />
    <meta name="referrer" content="origin-when-cross-origin" />

    <meta http-equiv="content-language" content={locale} />

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@arceprog" />
    <meta name="twitter:creator" content="@arceprog" />
    <meta property="twitter:domain" content="arceprog.dev" />
    <meta property="twitter:url" content={canonicalUrl} />
    <meta name="twitter:title" content={config.ogTitle} />
    <meta name="twitter:description" content={config.ogDescription} />
    <meta name="twitter:image" content="https://arceprog.dev/portada-og.png" />
    <meta name="twitter:image:alt" content={`${config.ogTitle} | Portfolio`} />

    <!-- Asegurar que WhatsApp pueda acceder -->
    <meta name="format-detection" content="telephone=no" />

    <!-- Discord Meta Tags (usa Open Graph) -->
    <meta name="theme-color" content="#121a2b" />

    <meta name="keywords" content={config.keywords} />
    <meta name="author" content="Felipe Arce" />
    <meta name="google" content="nositelinkssearchbox" />

    <!-- Structured Data: Person Schema -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Felipe Arce",
      "givenName": "Felipe",
      "familyName": "Arce",
      "jobTitle": config.jobTitle,
      "url": "https://arceprog.dev",
      "image": {
        "@type": "ImageObject",
        "url": "https://arceprog.dev/portada-og.png",
        "width": 1200,
        "height": 630
      },
      "description": config.ogDescription,
      "knowsAbout": allSkills,
      "knowsLanguage": [
        { "@type": "Language", "name": "Spanish", "alternateName": "es" },
        { "@type": "Language", "name": "English", "alternateName": "en" }
      ],
      "alumniOf": {
        "@type": "EducationalOrganization",
        "name": "Universidad Tecnológica Nacional",
        "sameAs": "https://www.utn.edu.ar/"
      },
      "hasCredential": {
        "@type": "EducationalOccupationalCredential",
        "name": "Técnico Universitario en Programación",
        "credentialCategory": "degree"
      },
      "worksFor": {
        "@type": "Organization",
        "name": "America Virtual",
        "url": "https://americavirtualsa.com/"
      },
      "sameAs": [
        "https://linkedin.com/in/arcefelipe/",
        "https://github.com/arceprogramando"
      ],
      "email": "arceprogramando@gmail.com",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Buenos Aires",
        "addressCountry": "AR"
      }
    })} />

    <!-- Structured Data: WebSite Schema -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Felipe Arce Portfolio",
      "alternateName": "arceprog.dev",
      "url": "https://arceprog.dev",
      "inLanguage": [locale === 'es' ? "es-AR" : "en-US"],
      "author": {
        "@type": "Person",
        "name": "Felipe Arce"
      },
      "dateModified": buildDate
    })} />

    <!-- Structured Data: BreadcrumbList Schema -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": breadcrumbName,
          "item": canonicalUrl
        }
      ]
    })} />
  </head>
  <body>
    <slot />

    <!-- Detección automática de idioma (solo primera visita) -->
    <script is:inline>
      (function() {
        const path = window.location.pathname;
        const isRoot = path === '/';
        const hasPreference = localStorage.getItem('locale-preference');

        if (isRoot && !hasPreference) {
          const lang = navigator.language || navigator.userLanguage || 'es';
          if (!lang.toLowerCase().startsWith('es')) {
            localStorage.setItem('locale-preference', 'en');
            window.location.replace('/en/');
          } else {
            localStorage.setItem('locale-preference', 'es');
          }
        }
      })();
    </script>
  </body>
</html>

<style is:global>
  html {
    font-family:
      Menlo,
      Monaco,
      Lucida Console,
      'Courier New',
      Courier,
      monospace;
    background: var(--color-bg-secondary);
    letter-spacing: -0.025rem;
    scroll-behavior: smooth;
  }

  body,
  figure {
    margin: 0;
    padding: 0;
    contain: layout style paint;
  }

  a {
    text-decoration: none;
  }

  ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  h1,
  h2,
  h3,
  h4 {
    margin: 0;
    font-family:
      system-ui,
      -apple-system,
      BlinkMacSystemFont,
      'Segoe UI',
      Roboto,
      Oxygen,
      Ubuntu,
      Cantarell,
      'Open Sans',
      'Helvetica Neue',
      sans-serif;
  }

  p {
    color: var(--color-text-primary);
    font-size: 0.9rem;
    line-height: 1.5;
    margin: 0;
    text-wrap: pretty;
  }

  .print {
    display: none !important;
  }

  @media print {
    .no-print {
      display: none !important;
    }

    .print {
      display: block !important;
    }

    astro-dev-toolbar {
      display: none !important;
    }

    article {
      break-inside: avoid;
    }
  }
</style>
